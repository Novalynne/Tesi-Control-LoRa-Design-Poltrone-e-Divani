{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}Generate Image{% endblock %}
{% block css %}
<style>
  .asteriskField { display: none; }
  label { font-weight: bold; }
  .helptext, .form-text, .text-muted { display: none !important; }

  #editCanvas {
    border: 2px solid #333;
    cursor: crosshair;
  }
</style>
{% endblock %}

{% block content %}
<div class="container">

  <h1 class="mt-4 mb-4 text-center">AI Image Generator</h1>

  <div class="card shadow p-4">
    <form id="imageForm" method="POST" enctype="multipart/form-data">
      {% csrf_token %}
      {{ form|crispy }}

      <div class="text-center mt-3">
        <button class="btn btn-primary btn-lg" type="submit">
          Generate Image
        </button>
      </div>
    </form>
  </div>

  <!-- Preview section -->
  <div class="mt-4 text-center">
    <h3>Preview Canny / HED</h3>
    <div class="row mt-4">
      <div class="col-md-6 text-center">
        <img id="originalPreview" src="" class="img-fluid border" style="max-height: 300px; display:none;">
        <p class="text-muted">Original Image</p>
      </div>

      <div class="col-md-6 text-center">
        <img id="combinedPreview" src="" class="img-fluid border" style="max-height: 300px; display:none;">
        <p class="text-muted">Canny / HED</p>
      </div>
    </div>
  </div>

  <!-- CANVAS EDITOR -->
  <div id="editorSection" class="mt-5 text-center" style="display:none;">
    <h3>Modify your Canny/Hed Guide Image</h3>

    <canvas id="editCanvas" width="512" height="512"></canvas>

    <div class="mt-3">
      <button type="button" id="drawModeBtn" class="btn btn-success btn-sm">‚úèÔ∏è Draw</button>
      <button type="button" id="eraseModeBtn" class="btn btn-danger btn-sm">üßπ Erase</button>

      <label class="ms-3 fw-bold">Brush Dimension:</label>
      <input id="brushSize" type="range" min="2" max="40" value="5">
    </div>
  </div>

</div>



<!-- JAVASCRIPT -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const imageInput = document.getElementById("id_input_image");
    const editorSection = document.getElementById("editorSection");
    const canvas = document.getElementById("editCanvas");
    const ctx = canvas.getContext("2d");

    let drawing = false;
    let mode = "draw";
    let brushSize = 5;

    const brushInput = document.getElementById("brushSize");
    const drawModeBtn = document.getElementById("drawModeBtn");
    const eraseModeBtn = document.getElementById("eraseModeBtn");

    // Cambia dimensione del pennello
    brushInput.addEventListener("input", () => {
      brushSize = parseInt(brushInput.value);
    });

    // Bottoni modalit√†
    drawModeBtn.addEventListener("click", () => mode = "draw");
    eraseModeBtn.addEventListener("click", () => mode = "erase");


    // --- CARICAMENTO E PREVIEW ---
    if (imageInput) {
      imageInput.addEventListener("change", function (event) {
        const file = event.target.files[0];
        if (!file) return;

        // Mostra anteprima originale
        const original = document.getElementById("originalPreview");
        original.src = URL.createObjectURL(file);
        original.style.display = "block";

        // Prepara AJAX
        const formData = new FormData();
        formData.append("image", file);

        fetch("{% url 'generate_preview' %}", {
          method: "POST",
          headers: { "X-CSRFToken": "{{ csrf_token }}" },
          body: formData
        })
                .then(response => response.json())
                .then(data => {
                  if (data.status === "ok") {
                    const combinedPreview = document.getElementById("combinedPreview");
                    combinedPreview.src = data.combined;
                    combinedPreview.style.display = "block";

                    // Quando HED √® caricato ‚Üí mostra editor + disegna l'immagine sul canvas
                    combinedPreview.onload = function () {
                      editorSection.style.display = "block";

                      // ridisegna HED nel canvas
                      ctx.clearRect(0, 0, canvas.width, canvas.height);
                      ctx.drawImage(combinedPreview, 0, 0, canvas.width, canvas.height);
                    };
                  }
                });
      });
    }


    // --- SISTEMA DI DISEGNO ---
    function drawPoint(x, y) {
      if (mode === "draw") {
        ctx.globalCompositeOperation = "source-over";
        ctx.fillStyle = "white";   // Bianco per disegnare
      } else {
        ctx.globalCompositeOperation = "source-over";
        ctx.fillStyle = "black";   // Nero per cancellare
      }

      ctx.beginPath();
      ctx.arc(x, y, brushSize, 0, Math.PI * 2);
      ctx.fill();
    }

    // Mouse
    canvas.addEventListener("mousedown", () => drawing = true);
    canvas.addEventListener("mouseup", () => { drawing = false; ctx.beginPath(); });
    canvas.addEventListener("mouseout", () => drawing = false);

    canvas.addEventListener("mousemove", (e) => {
      if (!drawing) return;
      const rect = canvas.getBoundingClientRect();
      drawPoint(e.clientX - rect.left, e.clientY - rect.top);
    });

    // Touch
    canvas.addEventListener("touchstart", () => drawing = true);
    canvas.addEventListener("touchend", () => { drawing = false; ctx.beginPath(); });
    canvas.addEventListener("touchcancel", () => drawing = false);

    canvas.addEventListener("touchmove", (e) => {
      if (!drawing) return;
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      drawPoint(e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top);
    });

  });
</script>

{% endblock %}
